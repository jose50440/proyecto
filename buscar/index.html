<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Clínico de Búsqueda</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Librerías de Datos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuración Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'] },
                extend: {
                    colors: {
                        brand: { 50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 500: '#0d9488', 600: '#0f766e', 700: '#115e59' },
                        accent: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#059669', 600: '#047857' },
                        surface: { 50: '#f8fafc', 100: '#f1f5f9' }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(160deg, #f8fafc 0%, #f0fdfa 40%, #ecfdf5 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card-elevated {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.06), 0 2px 4px -2px rgba(0,0,0,0.04);
            border: 1px solid rgba(241,245,249,0.8);
        }
        .card-elevated:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04); }
        .tab-btn.active { color: #0f766e; border-bottom: 2px solid #0d9488; background: linear-gradient(to bottom, #f0fdfa, transparent); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .toggle-checkbox:checked { right: 0; border-color: #059669; }
        .toggle-checkbox:checked + .toggle-label { background: linear-gradient(135deg, #059669, #0d9488); }
        .main-tab {
            border-radius: 0.75rem 0.75rem 0 0;
            transition: all 0.2s ease;
        }
        .main-tab.active { color: #0f766e; font-weight: 600; border-bottom: 2px solid #0d9488; background: rgba(255,255,255,0.9); }
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.35);
        }
        .btn-primary:hover { filter: brightness(1.05); box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4); }
    </style>
</head>
<body class="text-slate-800 font-sans min-h-screen flex flex-col overflow-x-hidden antialiased">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm">
        <div class="card-elevated w-full max-w-md mx-4 overflow-hidden" style="box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);">
            <div class="bg-gradient-to-br from-brand-600 to-brand-700 px-8 pt-10 pb-8 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white/20 text-white shadow-lg mb-4">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Portal Clínico</h1>
                <p class="text-sm text-white/80 mt-1">Inicie sesión para continuar</p>
            </div>
            <form id="login-form" onsubmit="return doLogin(event)" class="p-8 space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Usuario</label>
                    <input type="text" id="login-user" autocomplete="username" placeholder="Usuario" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-shadow" required />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-600 mb-2">Contraseña</label>
                    <input type="password" id="login-pass" autocomplete="current-password" placeholder="Contraseña" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-shadow" required />
                </div>
                <p id="login-error" class="text-sm text-red-600 hidden"></p>
                <button type="submit" class="btn-primary w-full py-3.5 rounded-xl font-semibold text-white transition-all">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- Contenedor principal (visible solo tras login) -->
    <div id="app-container" class="hidden flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 w-full glass-panel border-b border-slate-200/60">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-600 text-white shadow-sm">
                        <i data-lucide="heart-pulse" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight text-slate-900">Portal Clínico</h1>
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-widest">Gestión de Pacientes</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 flex-wrap justify-end">
                    <div id="connection-badge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 border border-slate-200">
                        <div class="relative flex h-2.5 w-2.5">
                            <span id="status-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                            <span id="status-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500"></span>
                        </div>
                        <span id="connection-text" class="text-xs font-medium text-slate-600">Conectando...</span>
                    </div>
                    <div id="file-origin-alert" class="hidden max-w-sm rounded-xl border border-amber-200 bg-amber-50/90 px-3 py-2 text-xs text-amber-800">
                        <strong>Abriste desde archivo (file://).</strong> Ejecuta <code class="bg-amber-100 px-1 rounded">npm start</code> y abre <code class="bg-amber-100 px-1 rounded">http://localhost:3000</code>
                    </div>
                    <button type="button" onclick="logout()" class="text-xs text-slate-500 hover:text-red-600 font-medium transition-colors">Cerrar sesión</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tabs principales -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-0 w-full">
        <div class="flex gap-0.5 border-b border-slate-200 bg-slate-50/50 rounded-t-xl px-1 pt-1">
            <button type="button" id="nav-tab-busqueda" onclick="switchMainTab('busqueda')" class="main-tab active px-5 py-2.5 text-sm font-medium text-slate-600">QR</button>
            <button type="button" id="nav-tab-medicamentos" onclick="switchMainTab('medicamentos')" class="main-tab px-5 py-2.5 text-sm font-medium text-slate-500 hover:text-slate-700">Lista de Medicamentos</button>
        </div>
    </div>

    <!-- Contenido -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">
        <div id="content-busqueda" class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            
            <!-- Panel Izquierdo: Config -->
            <div class="lg:col-span-4 space-y-5">
                <div class="card-elevated p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-brand-100/80 to-transparent rounded-bl-full"></div>
                    <h2 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="flex items-center justify-center w-9 h-9 rounded-lg bg-brand-100 text-brand-600"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i></span>
                        Configuración
                    </h2>
                    
                    <div class="space-y-5 relative z-10">
                        <div>
                            <label class="block text-sm font-semibold text-slate-600 mb-2">1. Columna a Buscar (A–H)</label>
                            <p class="text-[11px] text-slate-500 mb-1.5">Fila 1 de la hoja QR = encabezados</p>
                            <div class="relative">
                                <select id="dniColumnSelect" class="w-full pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 text-sm appearance-none disabled:bg-slate-100 disabled:text-slate-400 transition-colors" disabled>
                                    <option>Cargando...</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                            </div>
                        </div>

                        <div class="bg-slate-50/80 rounded-xl p-4 border border-slate-100">
                            <label class="block text-sm font-semibold text-slate-600 mb-2">2. Modo de Filtro</label>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700 font-medium" id="toggle-text">Eliminar Duplicados</span>
                                <div class="relative inline-block w-12 align-middle select-none">
                                    <input type="checkbox" id="uniqueMode" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 right-6 checked:right-0 transition-all duration-300" checked onclick="updateToggleLabel()"/>
                                    <label for="uniqueMode" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                                </div>
                            </div>
                            <p class="text-[11px] text-slate-500 mt-2" id="toggle-desc">1 resultado por valor. (Ideal DNI).</p>
                            <div id="smart-search-badge" class="hidden mt-2 flex items-center gap-1.5 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-lg border border-blue-100">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> <span class="font-semibold">Búsqueda Inteligente</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-elevated p-5 border border-slate-100">
                    <h3 class="text-xs font-bold text-brand-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-4 h-4"></i> Tips
                    </h3>
                    <ul class="space-y-2.5 text-sm text-slate-600">
                        <li class="flex items-start gap-2.5">
                            <i data-lucide="check-circle-2" class="w-4 h-4 text-brand-500 flex-shrink-0 mt-0.5"></i>
                            <span><b>DNI exacto:</b> deja "Eliminar Duplicados" activado.</span>
                        </li>
                        <li class="flex items-start gap-2.5">
                            <i data-lucide="search" class="w-4 h-4 text-blue-500 flex-shrink-0 mt-0.5"></i>
                            <span><b>Texto parcial:</b> desactívalo y escribe "sps", "ceiba", etc.</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Panel Derecho: Input y Resultados -->
            <div class="lg:col-span-8 space-y-6">
                
                <div class="card-elevated overflow-hidden flex flex-col h-[360px]">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                        <label class="text-base font-bold text-slate-800 flex items-center gap-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 text-slate-600"><i data-lucide="file-input" class="w-4 h-4"></i></span>
                            Ingreso de Datos
                        </label>
                        <div class="flex items-center gap-2">
                            <button onclick="clearInput()" class="text-xs text-slate-500 hover:text-red-600 flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg hover:bg-red-50 transition-colors">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Limpiar
                            </button>
                            <span class="bg-slate-100 text-slate-500 text-xs px-2.5 py-1 rounded-lg font-medium">Soporta 5000+</span>
                        </div>
                    </div>
                    <div class="relative flex-grow p-5 pt-0">
                        <textarea id="inputDNI" class="w-full h-full p-4 bg-slate-50/50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 resize-none font-mono text-sm text-slate-700 placeholder-slate-400 transition-all custom-scrollbar" placeholder="Ej: 0801199912345 (Modo Duplicados ON)&#10;Ej: sps, ceiba (Modo Duplicados OFF)"></textarea>
                        <div class="absolute bottom-5 right-5 z-10">
                            <button id="processBtn" onclick="processData()" disabled class="btn-primary flex items-center gap-2 text-white px-6 py-3 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                                <span id="btn-icon"><i data-lucide="search" class="w-5 h-5"></i></span>
                                <span id="btn-text">Procesar Datos</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DE RESULTADOS -->
                <div id="results-area" class="hidden card-elevated overflow-hidden mt-6">
                    <div class="flex justify-between items-center border-b border-slate-200 bg-slate-50/70 px-5 py-3">
                        <div class="flex gap-1">
                            <button onclick="switchTab('resumen')" id="tab-resumen" class="tab-btn active text-sm font-medium text-slate-600 hover:text-slate-900 px-4 py-2 rounded-lg transition-colors">Resultados</button>
                            <button onclick="switchTab('estadisticas')" id="tab-estadisticas" class="tab-btn text-sm font-medium text-slate-500 hover:text-slate-900 px-4 py-2 rounded-lg transition-colors">Estadísticas</button>
                        </div>
                        <button id="btnDownloadExcel" onclick="downloadExcel()" class="hidden flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-sm transition-all">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Descargar Excel
                        </button>
                    </div>

                    <div id="content-resumen" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="rounded-xl p-5 bg-slate-50 border border-slate-100">
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider mb-1">Buscados</p>
                                <h4 class="text-2xl font-bold text-slate-800" id="stat-total">0</h4>
                            </div>
                            <div class="rounded-xl p-5 bg-emerald-50/80 border border-emerald-100">
                                <p class="text-xs text-emerald-600 font-semibold uppercase tracking-wider mb-1">Encontrados</p>
                                <h4 class="text-2xl font-bold text-slate-800" id="stat-found">0</h4>
                            </div>
                            <div class="rounded-xl p-5 bg-red-50/80 border border-red-100">
                                <p class="text-xs text-red-600 font-semibold uppercase tracking-wider mb-1">No Encontrados</p>
                                <h4 class="text-2xl font-bold text-slate-800" id="stat-missing">0</h4>
                            </div>
                        </div>

                        <div id="found-section" class="mb-6 hidden">
                            <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i> Resultados (columnas A–H)</h4>
                            <div id="found-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[380px] overflow-y-auto custom-scrollbar"></div>
                        </div>

                        <div id="missing-section" class="hidden rounded-xl border border-red-100 overflow-hidden bg-red-50/50">
                            <div class="px-4 py-3 flex justify-between items-center border-b border-red-100">
                                <h4 class="text-xs font-bold text-red-700 flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i> Sin Coincidencia</h4>
                                <button onclick="copyAllMissing()" class="text-xs bg-white text-red-600 px-3 py-1.5 rounded-lg border border-red-200 hover:bg-red-50 font-semibold transition-colors">Copiar Lista</button>
                            </div>
                            <div id="missing-cards-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 p-4 max-h-[180px] overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>

                    <div id="content-estadisticas" class="hidden p-6 bg-slate-50/30">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="card-elevated p-6">
                                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Promedio de filas</h3>
                                <div class="flex items-baseline gap-2">
                                    <span id="stat-avg" class="text-3xl font-bold text-brand-600">0.0</span>
                                    <span class="text-slate-400 text-sm">por paciente</span>
                                </div>
                            </div>
                            <div class="card-elevated p-6">
                                <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Mayor frecuencia</h3>
                                <h4 id="stat-max-dni" class="text-lg font-bold text-slate-800">---</h4>
                                <span id="stat-max-count" class="text-sm text-emerald-600 font-semibold">0 filas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Medicamentos -->
        <div id="content-medicamentos" class="hidden">
            <div class="card-elevated p-6">
                <h2 class="text-base font-bold text-slate-800 mb-2 flex items-center gap-2">
                    <span class="flex items-center justify-center w-9 h-9 rounded-lg bg-brand-100 text-brand-600"><i data-lucide="pill" class="w-5 h-5"></i></span>
                    Lista de Medicamentos
                </h2>
                <p class="text-sm text-slate-500 mb-5">Columnas A–C de la hoja LISTA DE MEDICAMENTOS. Filtra por nombre.</p>
                <div class="relative mb-5">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                    <input type="text" id="medicamento-filter" placeholder="Buscar medicamento (ej: amlodipina, aspirina)..." class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:bg-white transition-colors" oninput="filterMedicamentos()" />
                </div>
                <div id="medicamentos-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
                <p id="medicamentos-count" class="text-sm text-slate-500 mt-4 font-medium"></p>
            </div>
        </div>
    </main>

    </div>
    <!-- fin app-container -->

    <!-- Modal -->
    <div id="patient-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <div class="relative card-elevated w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden" style="box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2);">
                <div class="bg-gradient-to-r from-brand-600 to-brand-700 px-5 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-white" id="modal-title">Paciente</h3>
                    <button onclick="closeModal()" class="text-white/90 hover:text-white p-2 rounded-lg hover:bg-white/10 transition-colors" aria-label="Cerrar"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="px-5 py-5 max-h-[65vh] overflow-y-auto custom-scrollbar bg-slate-50/50" id="modal-content"></div>
                <div class="px-5 py-4 border-t border-slate-200 bg-white flex justify-end">
                    <button type="button" class="btn-primary px-5 py-2.5 rounded-xl text-sm font-semibold text-white" onclick="closeModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script>
        // --- CONFIGURACIÓN E INICIO (datos no expuestos en fuente) ---
        (function() {
            var _k = 0x2a;
            window._d = function(a, k) { k = k || _k; return a.map(function(c) { return String.fromCharCode((c ^ k) & 0xff); }).join(''); };
            window._b = function(s) { try { return (typeof atob !== 'undefined' ? atob(s) : ''); } catch(e) { return ''; } };
        })();
        var _1 = [75,78,71,67,68], _2 = [66,88,68,24,26,24,28], _3 = 'aHR0cHM6Ly9kb2NzLmdvb2dsZS5jb20vc3ByZWFkc2hlZXRzL2QvZS8yUEFDWC0xdlJhMHZ5UEVvbl9RbzA1LS0wMzR1bGtzb2k5UENfZV9FdzF6TXFKQTR0NV9kMzMzUW5YSHlIcDh5elFCY09QR0J6N3NIT1lxMmotbjVlQy9wdWI=';
        // QR = búsqueda de pacientes (columnas A-H). LISTA DE MEDICAMENTOS = pestaña medicamentos (columnas A-C). Pon el gid de cada hoja.
        var _sheets = [
            { name: 'QR', gid: '375135436' },
            { name: 'LISTA DE MEDICAMENTOS', gid: '0' }
        ];
        let sheetsData = {};
        let dbData = [];
        let headers = [];
        let excelDataExport = [];
        let medicamentosList = [];
        
        // Diccionario Inteligente
        const abbrMap = {
            'sps': 'san pedro sula', 'sp': 'san pedro sula',
            'tgu': 'tegucigalpa', 'teg': 'tegucigalpa', 'tegus': 'tegucigalpa',
            'ceiba': 'la ceiba', 'progreso': 'el progreso', 'src': 'santa rosa de copan'
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (isLoggedIn()) {
                showApp();
                loadDatabase();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        function isLoggedIn() {
            return sessionStorage.getItem('portal_clinico_auth') === '1';
        }

        function doLogin(e) {
            e.preventDefault();
            const user = (document.getElementById('login-user').value || '').trim();
            const pass = (document.getElementById('login-pass').value || '');
            const errEl = document.getElementById('login-error');
            if (user === _d(_1) && pass === _d(_2)) {
                sessionStorage.setItem('portal_clinico_auth', '1');
                errEl.classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('flex');
                loadDatabase();
                lucide.createIcons();
                return false;
            }
            errEl.textContent = 'Usuario o contraseña incorrectos.';
            errEl.classList.remove('hidden');
            return false;
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
        }

        function logout() {
            sessionStorage.removeItem('portal_clinico_auth');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('flex');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }

        function switchMainTab(tab) {
            var busqueda = document.getElementById('content-busqueda');
            var medicamentos = document.getElementById('content-medicamentos');
            var btnBusqueda = document.getElementById('nav-tab-busqueda');
            var btnMedicamentos = document.getElementById('nav-tab-medicamentos');
            if (tab === 'busqueda') {
                busqueda.classList.remove('hidden');
                medicamentos.classList.add('hidden');
                btnBusqueda.classList.add('active', 'text-brand-600');
                btnBusqueda.classList.remove('text-gray-500');
                btnMedicamentos.classList.remove('active', 'text-brand-600');
                btnMedicamentos.classList.add('text-gray-500');
            } else {
                busqueda.classList.add('hidden');
                medicamentos.classList.remove('hidden');
                btnMedicamentos.classList.add('active', 'text-brand-600');
                btnMedicamentos.classList.remove('text-gray-500');
                btnBusqueda.classList.remove('active', 'text-brand-600');
                btnBusqueda.classList.add('text-gray-500');
                renderMedicamentosList(medicamentosList);
            }
            lucide.createIcons();
        }

        function buildMedicamentosList() {
            var set = new Set();
            var sh = sheetsData['LISTA DE MEDICAMENTOS'];
            if (!sh || !sh.headers || !sh.data) { medicamentosList = []; renderMedicamentosList(medicamentosList); return; }
            var cols = sh.headers.slice(0, 3);
            sh.data.forEach(function(row) {
                cols.forEach(function(h) {
                    var val = String(row[h] != null ? row[h] : '').trim();
                    if (val.length > 0) set.add(val);
                });
            });
            medicamentosList = Array.from(set).sort(function(a, b) { return a.localeCompare(b, 'es'); });
            renderMedicamentosList(medicamentosList);
        }

        function filterMedicamentos() {
            const q = (document.getElementById('medicamento-filter').value || '').trim();
            const norm = cleanString(q);
            const filtered = q
                ? medicamentosList.filter(name => cleanString(name).includes(norm))
                : medicamentosList;
            renderMedicamentosList(filtered);
        }

        function renderMedicamentosList(list) {
            const container = document.getElementById('medicamentos-list');
            const countEl = document.getElementById('medicamentos-count');
            container.innerHTML = '';
            list.forEach(name => {
                const div = document.createElement('div');
                div.className = 'card-elevated p-3 rounded-xl border border-slate-100 text-sm text-slate-700';
                div.textContent = name;
                container.appendChild(div);
            });
            countEl.textContent = list.length + ' medicamento(s)';
        }

        function getSheetUrl(gid) {
            var base = _b(_3);
            if (!base) return '';
            return base + (gid ? '?gid=' + gid + '&single=true&output=csv' : '?output=csv');
        }

        function fetchCsv(url, done) {
            var fromFile = (typeof window !== 'undefined' && window.location && window.location.protocol === 'file:');
            var encoded = encodeURIComponent(url);
            var proxies = [
                'https://corsproxy.io/?url=' + encoded,
                'https://api.allorigins.win/raw?url=' + encoded
            ];
            var target = fromFile ? proxies[0] : url;
            function tryNext(idx) {
                var nextUrl = idx < 0 ? target : (proxies[idx] || null);
                if (!nextUrl) { done(new Error('No se pudo cargar')); return; }
                fetch(nextUrl, { mode: 'cors' })
                    .then(function(r) { return r.ok ? r.text() : Promise.reject(new Error('HTTP ' + r.status)); })
                    .then(function(text) {
                        if (text && text.length > 0 && !/^\s*<html/i.test(text)) { done(null, text); return; }
                        tryNext(idx + 1);
                    })
                    .catch(function() {
                        if (fromFile && idx < 0) tryNext(0);
                        else if (idx + 1 < proxies.length) tryNext(idx + 1);
                        else done(new Error('No se pudo cargar'));
                    });
            }
            if (fromFile) tryNext(0);
            else tryNext(-1);
        }

        function loadDatabase() {
            var total = 0;
            var loaded = 0;
            var fromFile = typeof window !== 'undefined' && window.location && window.location.protocol === 'file:';
            var sheetsToLoad = fromFile ? _sheets.slice(0, 2) : _sheets;
            var totalSheets = sheetsToLoad.length;
            function onSheetDone(name, results) {
                if (results && results.data && results.data.length > 0) {
                    sheetsData[name] = { headers: results.meta.fields || [], data: results.data };
                    total += results.data.length;
                }
                loaded++;
                if (loaded === totalSheets) {
                    var first = _sheets[0];
                    if (sheetsData[first.name]) {
                        dbData = sheetsData[first.name].data;
                        headers = sheetsData[first.name].headers;
                        setOnlineStatus(true, total);
                        populateSelect();
                        buildMedicamentosList();
                    } else {
                        setOnlineStatus(false);
                        showToast('error', 'No se pudo cargar ninguna hoja. Revisa que el enlace est\u00e9 publicado.');
                        if (fromFile) {
                            var alertEl = document.getElementById('file-origin-alert');
                            if (alertEl) alertEl.classList.remove('hidden');
                        }
                    }
                }
            }
            sheetsToLoad.forEach(function(sheet) {
                var url = getSheetUrl(sheet.gid);
                if (!url) { onSheetDone(sheet.name, null); return; }
                fetchCsv(url, function(err, csvText) {
                    if (err || !csvText) { onSheetDone(sheet.name, null); return; }
                    var res = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                    onSheetDone(sheet.name, res);
                });
            });
        }

        // --- FUNCIONES UI ---
        function setOnlineStatus(isOnline, count = 0) {
            const dot = document.getElementById('status-dot');
            const ping = document.getElementById('status-ping');
            const text = document.getElementById('connection-text');
            const badge = document.getElementById('connection-badge');
            const btn = document.getElementById('processBtn');
            const select = document.getElementById('dniColumnSelect');

            if (isOnline) {
                dot.className = "relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500";
                ping.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75";
                text.innerHTML = `Conectado <span class="font-semibold text-emerald-700">(${count})</span>`;
                badge.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-50 border border-emerald-200";
                btn.disabled = false;
                select.disabled = false;
            } else {
                dot.className = "bg-red-500 h-2.5 w-2.5 rounded-full";
                ping.className = "hidden";
                text.innerText = "Error Conexión";
                badge.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-50 border border-red-200";
            }
        }

        function populateSelect() {
            const select = document.getElementById('dniColumnSelect');
            select.innerHTML = '';
            let found = false;
            
            // Limitamos a las primeras 8 columnas (Indices 0 a 7 -> A a H)
            const limitedHeaders = headers.slice(0, 8);

            limitedHeaders.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.text = h;
                if (!found && h.match(/dni|identidad|cedula|id/i)) { opt.selected = true; found = true; }
                select.appendChild(opt);
            });
        }

        function updateToggleLabel() {
            const isChecked = document.getElementById('uniqueMode').checked;
            const label = document.getElementById('toggle-text');
            const desc = document.getElementById('toggle-desc');
            const badge = document.getElementById('smart-search-badge');

            if(isChecked) {
                label.innerText = "Eliminar Duplicados";
                desc.innerText = "1 resultado por valor exacto.";
                badge.classList.add('hidden');
            } else {
                label.innerText = "Mostrar Todos (Inteligente)";
                desc.innerText = "Busca texto parcial y abreviaturas.";
                badge.classList.remove('hidden');
            }
        }

        function switchTab(tab) {
            document.getElementById('content-resumen').classList.add('hidden');
            document.getElementById('content-estadisticas').classList.add('hidden');
            document.getElementById('tab-resumen').classList.remove('active', 'border-brand-600', 'text-brand-600');
            document.getElementById('tab-estadisticas').classList.remove('active', 'border-brand-600', 'text-brand-600');
            
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.classList.add('active', 'border-brand-600', 'text-brand-600');
        }

        function clearInput() {
            document.getElementById('inputDNI').value = '';
            document.getElementById('results-area').classList.add('hidden');
            document.getElementById('btnDownloadExcel').classList.add('hidden');
        }

        function cleanString(str) {
            return str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() : "";
        }

        // --- LÓGICA PRINCIPAL ---
        function processData() {
            const inputVal = document.getElementById('inputDNI').value;
            const col = document.getElementById('dniColumnSelect').value;
            const isUnique = document.getElementById('uniqueMode').checked;
            
            if (!inputVal.trim()) { showToast('info', 'Ingresa datos para buscar'); return; }

            // UI Loading
            const btn = document.getElementById('processBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Procesando...`;
            btn.disabled = true;
            lucide.createIcons();

            setTimeout(function() {
                try {
                    var rawList = inputVal.split(/[\n,;\t]+/).map(function(s) { return s.trim(); }).filter(function(s) { return s !== ''; });
                    var foundByTerm = {};
                    var missingList = [];
                    var freqMap = new Map();
                    excelDataExport = [];

                    var searchSet = isUnique ? new Set(rawList) : null;
                    var searchTerms = isUnique ? null : rawList.map(function(t) {
                        var norm = cleanString(t);
                        return { original: t, norm: abbrMap[norm] || norm };
                    });

                    var sh = sheetsData['QR'];
                    if (sh && sh.data) {
                        var sheetHeaders = sh.headers || [];
                        sh.data.forEach(function(row) {
                            var val = String(row[col] || '').trim();
                            var valNorm = cleanString(val);
                            var matchedTerm = null;
                            if (isUnique) {
                                if (searchSet.has(val)) matchedTerm = val;
                            } else {
                                for (var i = 0; i < searchTerms.length; i++) {
                                    if (valNorm.indexOf(searchTerms[i].norm) !== -1) {
                                        matchedTerm = searchTerms[i].original;
                                        break;
                                    }
                                }
                            }
                            if (matchedTerm) {
                                freqMap.set(matchedTerm, (freqMap.get(matchedTerm) || 0) + 1);
                                if (!foundByTerm[matchedTerm]) foundByTerm[matchedTerm] = [];
                                foundByTerm[matchedTerm].push({ sheetName: 'QR', row: row, headers: sheetHeaders });
                            }
                        });
                    }

                    var foundList = Object.keys(foundByTerm).map(function(term) {
                        return { term: term, occurrences: foundByTerm[term] };
                    });
                    var foundSet = new Set(Object.keys(foundByTerm));
                    missingList = rawList.filter(function(x) { return !foundSet.has(x); });

                    var qrHeadersAtoH = (sheetsData['QR'] && sheetsData['QR'].headers) ? sheetsData['QR'].headers.slice(0, 8) : [];
                    foundList.forEach(function(f) {
                        f.occurrences.forEach(function(occ) {
                            var r = {};
                            qrHeadersAtoH.forEach(function(k) { r[k] = occ.row[k] != null ? occ.row[k] : ''; });
                            r['Hoja'] = occ.sheetName;
                            excelDataExport.push(r);
                        });
                    });
                    lastMissingDNIs = missingList;

                    renderStats(rawList.length, foundList.length, missingList.length);
                    renderCards(foundList);
                    renderMissing(missingList);
                    renderAdvStats(freqMap);

                    // Mostrar Resultados
                    document.getElementById('results-area').classList.remove('hidden');
                    
                    // Mostrar Botón Excel si hay datos
                    const btnExcel = document.getElementById('btnDownloadExcel');
                    if(excelDataExport.length > 0) {
                        btnExcel.classList.remove('hidden');
                    } else {
                        btnExcel.classList.add('hidden');
                    }

                    showToast(foundList.length > 0 ? 'success' : 'warning', `Se encontraron ${foundList.length} registros`);

                } catch (e) {
                    console.error(e);
                    showToast('error', 'Error al procesar datos');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            }, 500);
        }

        // --- NUEVA FUNCIÓN: DESCARGA MANUAL ---
        function downloadExcel() {
            if (!excelDataExport || excelDataExport.length === 0) {
                showToast('warning', 'No hay datos para descargar');
                return;
            }
            try {
                var exportHeaders = Object.keys(excelDataExport[0]);
                var ws = XLSX.utils.json_to_sheet(excelDataExport, { header: exportHeaders });
                var wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Resultados');
                XLSX.writeFile(wb, 'Busqueda_' + new Date().toISOString().slice(0, 10) + '.xlsx');
                showToast('success', 'Excel descargado correctamente');
            } catch (e) {
                console.error(e);
                showToast('error', 'Error al generar el Excel');
            }
        }

        // --- RENDERIZADO ---
        function renderStats(total, found, missing) {
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-found').innerText = found;
            document.getElementById('stat-missing').innerText = missing;
        }

        function renderCards(list) {
            var container = document.getElementById('found-cards-container');
            var section = document.getElementById('found-section');
            container.innerHTML = '';
            if (list.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');
            var nameKey = headers.find(function(h) { return /nombre|name|paciente/i.test(h); });
            list.slice(0, 100).forEach(function(item) {
                var title = item.term;
                var firstRow = item.occurrences[0].row;
                var subtitle = nameKey ? (firstRow[nameKey] || '') : '';
                var sheetsLabel = item.occurrences.map(function(o) { return o.sheetName; }).join(', ');
                if (!subtitle) subtitle = 'En: ' + sheetsLabel; else subtitle = subtitle + ' · ' + sheetsLabel;
                var div = document.createElement('div');
                div.className = 'card-elevated p-4 rounded-xl cursor-pointer flex justify-between items-center border border-slate-100';
                div.onclick = function() { openModalPaciente(item); };
                div.innerHTML = '<div class="overflow-hidden min-w-0"><p class="text-sm font-semibold text-slate-800 truncate">' + title + '</p><p class="text-xs text-slate-500 truncate mt-0.5">' + subtitle + '</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 flex-shrink-0"></i>';
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderMissing(list) {
            const container = document.getElementById('missing-cards-container');
            const section = document.getElementById('missing-section');
            container.innerHTML = '';

            if(list.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            list.forEach(val => {
                const btn = document.createElement('button');
                btn.className = "text-left text-xs bg-white border border-red-100 text-red-600 p-2.5 rounded-lg hover:bg-red-50 truncate font-mono transition-colors";
                btn.innerText = val;
                btn.onclick = () => copyText(val);
                container.appendChild(btn);
            });
        }

        function renderAdvStats(freqMap) {
            let maxVal = 0, maxKey = '--', sum = 0, count = 0;
            freqMap.forEach((v, k) => {
                sum += v; count++;
                if(v > maxVal) { maxVal = v; maxKey = k; }
            });
            const avg = count ? (sum/count).toFixed(1) : "0";
            document.getElementById('stat-avg').innerText = avg;
            document.getElementById('stat-max-dni').innerText = maxKey;
            document.getElementById('stat-max-count').innerText = maxVal + " filas";
        }

        // --- MODAL PACIENTE (muestra directa de la fila A–H, un solo resultado) ---
        var _modalPaciente = null;

        function openModalPaciente(item) {
            _modalPaciente = item;
            document.getElementById('modal-title').textContent = item.term;
            if (item.occurrences && item.occurrences[0]) {
                modalShowRow(item.occurrences[0]);
            }
            document.getElementById('patient-modal').classList.remove('hidden');
        }

        function modalShowRow(occ) {
            var content = document.getElementById('modal-content');
            content.innerHTML = '';
            var headers = (occ.headers || []).slice(0, 8);
            var row = occ.row || {};
            headers.forEach(function(h) {
                var v = row[h];
                if (v === undefined || v === null) v = '';
                var val = String(v).trim();
                content.innerHTML += '<div class="bg-white p-3 rounded-xl border border-slate-100 mb-2 shadow-sm"><p class="text-[10px] font-bold text-brand-600 uppercase tracking-wider mb-1">' + h + '</p><p class="text-sm text-slate-800 break-words">' + (val || '—') + '</p></div>';
            });
        }

        function closeModal() {
            document.getElementById('patient-modal').classList.add('hidden');
            _modalPaciente = null;
        }

        let lastMissingDNIs = [];
        function copyAllMissing() {
            if(lastMissingDNIs.length) copyText(lastMissingDNIs.join('\n'));
        }

        function copyText(txt) {
            const ta = document.createElement('textarea');
            ta.value = txt;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showToast('success', 'Copiado al portapapeles');
        }

        function showToast(type, msg) {
            const box = document.createElement('div');
            const colors = type === 'success' ? 'bg-slate-800 text-white border-emerald-500' : 
                           type === 'error' ? 'bg-white text-red-600 border-red-300 shadow-lg' : 'bg-white text-slate-800 border-brand-200 shadow-lg';
            box.className = `p-3 rounded-xl border-l-4 text-sm font-medium shadow-lg ${colors}`;
            box.innerText = msg;
            const container = document.getElementById('toast-container');
            container.appendChild(box);
            setTimeout(() => box.remove(), 3000);
        }
    </script>
</body>
</html>
